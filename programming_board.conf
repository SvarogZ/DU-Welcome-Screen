{"slots":{"0":{"name":"slot1","type":{"events":[],"methods":[]}},"1":{"name":"slot2","type":{"events":[],"methods":[]}},"2":{"name":"slot3","type":{"events":[],"methods":[]}},"3":{"name":"slot4","type":{"events":[],"methods":[]}},"4":{"name":"slot5","type":{"events":[],"methods":[]}},"5":{"name":"slot6","type":{"events":[],"methods":[]}},"6":{"name":"slot7","type":{"events":[],"methods":[]}},"7":{"name":"slot8","type":{"events":[],"methods":[]}},"8":{"name":"slot9","type":{"events":[],"methods":[]}},"9":{"name":"slot10","type":{"events":[],"methods":[]}},"-1":{"name":"unit","type":{"events":[],"methods":[]}},"-2":{"name":"system","type":{"events":[],"methods":[]}},"-3":{"name":"library","type":{"events":[],"methods":[]}}},"handlers":[{"code":"-------------------------------\n---- CUSTOM VARIABLES ---------\n-------------------------------\nlocal stringMax = 1024 --export: max string lengh to transmite in one cycle\nlocal startPattern = \"[s]\" --export: pattern to indicate the start of the package\nlocal stopPattern = \"[e]\" --export: pattern to indicate the end of the package\nlocal update_time = 0.1 --export: cycle for the package of data\nlocal timeout = 3600 --export: timeout for the counter in seconds\nlocal clearDatabank = false --export: select to clear the databank when programming board started\n\nunit.hide()\n-------------------------------\n---- SLOTS DETECTION ----------\n-------------------------------\nlocal screens = {}\nlocal databanks = {}\n\nlocal function initiateSlots()\n\tfor _, slot in pairs(unit) do\n\t\tif type(slot) == \"table\" and type(slot.export) == \"table\" and slot.getElementClass then\n\t\t\tlocal elementClass = slot.getElementClass():lower()\n\t\t\tif elementClass == \"databankunit\" then\n\t\t\t\ttable.insert(databanks,slot)\n\t\t\telseif elementClass == \"screenunit\" then\n\t\t\t\ttable.insert(screens,slot)\n\t\t\tend\n\t\tend\n\tend\n\t\n\tif #databanks < 1 then\n\t\terror(\"No databank connected!\")\n\tend\n\n\tif #screens < 1 then\n\t\terror(\"No screen connected!\")\n\tend\n\t\n\ttable.sort(screens, function (a, b) return (a.getId() < b.getId()) end)\n\ttable.sort(databanks, function (a, b) return (a.getId() < b.getId()) end)\nend\n\ninitiateSlots()\n\n\nlocal databankSlot = databanks[1]\nif clearDatabank then\n\tdatabankSlot.clear()\nend\n\n-------------------------------\n---- IDENTIFY AND COUNT USER --\n-------------------------------\nlocal masterPlayerId = unit.getMasterPlayerId()\nlocal masterPlayerName = system.getPlayerName(masterPlayerId)\nlocal visitTime = system.getArkTime()\n\nlocal user = {}\n\nlocal userString = databankSlot.getStringValue(masterPlayerId)\nif userString and userString ~= \"\" then\n\tuser = json.decode(userString)\nelse\n\tuser.name = masterPlayerName\n\tuser.counter = 1\nend\n\nif user.time and visitTime - user.time > timeout then\n\tuser.lastTime = user.time\n\tuser.counter = user.counter + 1\nend\n\nuser.time = visitTime\nlocal previousVisit = user.lastTime\n\nif user.name ~= masterPlayerName then\n\t--name is changed since last visit\n\tuser.previousName = user.name\n\tuser.name = masterPlayerName\nend\n\n-- record to the databank\ndatabankSlot.setStringValue(masterPlayerId,json.encode(user))\n\n-------------------------------\n---- SHOW ON SCREEN -----------\n-------------------------------\nif screens[1] then\n\tlocal data = {}\n\tdata[1] = masterPlayerName\n\n\tif previousVisit then\n\t\tdata[2] = visitTime - previousVisit\n\tend\n\n\tlocal dataString = json.encode(data)\n\tscreens[1].setScriptInput(dataString)\nend\n\nlocal dataString = \"\"\n\nif screens[2] then\n\tlocal keyListString = databankSlot.getKeys()\n\tlocal keyList = {}\n\tif keyListString and keyListString ~= \"\" then\n\t\tkeyList = json.decode(keyListString)\n\tend\n\n\tlocal users = {}\n\n\tfor _, id in ipairs(keyList) do\n\t\tlocal userObjectString = databankSlot.getStringValue(id)\n\t\tif userObjectString and userObjectString ~= \"\" then\n\t\t\tlocal userObject = json.decode(userObjectString)\n\t\t\tlocal name = userObject.name or \"Unknown\"\n\t\t\tlocal time = userObject.time or 0\n\t\t\tlocal lastTime = userObject.lastTime or time\n\t\t\tlocal counter = userObject.counter or 0\n\t\t\tlocal objectToRecord = {id, name, visitTime - time, visitTime - lastTime, counter}\n\t\t\ttable.insert(users,objectToRecord)\n\t\tend\n\tend\n\n\tdataString = json.encode(users)\n\t\n\tunit.setTimer(\"transmission\", update_time)\nend\n\n--system.print(\"string = \"..dataString)\n\nfunction transmission()\n\tif not isTransmissionInProgress then\n\t\tstringToTransmit = startPattern .. dataString .. stopPattern\n\t\t--system.print(\"stringToTransmit = \"..stringToTransmit)\n\t\tisTransmissionInProgress = true\n\tend\n\t\n\tif #stringToTransmit > stringMax then\n\t\tscreens[2].setScriptInput(string.sub(stringToTransmit,1,stringMax))\n\t\tstringToTransmit = string.sub(stringToTransmit,stringMax+1)\n\telse\n\t\tscreens[2].setScriptInput(stringToTransmit)\n\t\tisTransmissionInProgress = false\n\t\tunit.stopTimer(\"transmission\")\n\t\tsystem.print(\"transmission complete\")\n\tend\n\nend","filter":{"args":[],"signature":"start()","slotKey":"-1"},"key":"0"},{"code":"transmission()","filter":{"args":[{"value":"transmission"}],"signature":"tick(timerId)","slotKey":"-1"},"key":"1"}],"methods":[],"events":[]}
